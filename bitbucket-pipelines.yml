image:
  name: atlassian/default-image:3

test: &test
  step:
    name: Test
    script:
      - npm install -g bats
      - chmod a+x test/*.bats
      - bats test/test.bats
    services:
      - docker

push-dev: &push-dev
  step:
    name: Push Dev version
    script:
      - ENV=dev bash bump-version.sh
      - pipe: atlassian/bitbucket-pipe-release:5.0.1
        variables:
          REGISTRY_USERNAME: $DOCKER_HUB_USERNAME
          REGISTRY_PASSWORD: $DOCKER_HUB_PASSWORD
          DOCKERFILE: ./Dockerfile_pre
          IMAGE: scribesecurity/$BITBUCKET_REPO_SLUG
          VERSION: dev-latest
          GIT_PUSH: 'false'

push: &push
  step:
    name: Push and Tag
    image: python:3.7
    script:
      - bash bump-version.sh
      - pipe: atlassian/bitbucket-pipe-release:5.0.1
        variables:
          REGISTRY_USERNAME: $DOCKER_HUB_USERNAME
          REGISTRY_PASSWORD: $DOCKER_HUB_PASSWORD
          IMAGE: scribesecurity/$BITBUCKET_REPO_SLUG
    services:
      - docker

pipelines:
  default:
    - <<: *test
  branches:
    master:
      - <<: *test
      - <<: *push
  custom:
    push-dev:
      - <<: *push-dev